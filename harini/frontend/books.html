<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Clerk - Book Inventory</title>
  <link rel="stylesheet" href="clerk.css">
</head>
<body>
  <div class="layout">
    <!-- Sidebar will be injected by clerk-menu.js -->

    <main class="main container">
      <h1>Book Inventory Management</h1>

      <section id="add-book">
        <h3>Add a new book</h3>
        <div class="form-row">
          <input id="isbn" placeholder="ISBN">
          <input id="title" placeholder="Title">
          <input id="author" placeholder="Author">
          <input id="category" placeholder="Category">
          <button class="btn" id="addBtn">Add</button>
        </div>
        <div id="addResult"></div>
      </section>

      <section id="existing">
        <h3>Existing Books</h3>
        <table class="table" id="booksTable">
          <thead><tr><th>ID</th><th>ISBN</th><th>Title</th><th>Author</th><th>Category</th><th>Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </section>
    </main>
  <link rel="stylesheet" href="clerk-menu.css">
  <script src="clerk-menu.js" defer></script>

<script>
const apiBase = '/clerk';

let lastBooks = [];
let activeCategory = 'All';

async function fetchBooks(){
  try{
    const r = await fetch('/api/books');
    const data = await r.json();
    lastBooks = data || [];
    renderBooks();
    renderCategories();
  }catch(e){console.error(e)}
}

function renderBooks(){
  const tbody = document.querySelector('#booksTable tbody');
  tbody.innerHTML = '';
  const shown = lastBooks.filter(b => activeCategory === 'All' || (b.category || '').toLowerCase() === activeCategory.toLowerCase());
  shown.forEach(b=>{
    const tr = document.createElement('tr');
  tr.innerHTML = `<td>${b.id}</td><td>${b.isbn}</td><td>${b.title}</td><td>${b.author||''}</td><td>${b.category||''}</td><td><button onclick="edit(${b.id})">Edit</button> <button onclick="archive(${b.id})">Delete</button></td>`;
    tbody.appendChild(tr);
  })
}

function renderCategories(){
  const set = new Set();
  lastBooks.forEach(b=>{ if (b.category) set.add(b.category); });
  const list = document.getElementById('categoryList');
  list.innerHTML = '';
  const all = document.createElement('div'); all.className='category-item'; all.innerText='All'; all.onclick = ()=>{ activeCategory='All'; renderBooks(); highlightCategory('All'); };
  list.appendChild(all);
  set.forEach(cat=>{
    const el = document.createElement('div'); el.className='category-item'; el.innerText = cat; el.onclick = ()=>{ activeCategory=cat; renderBooks(); highlightCategory(cat); };
    list.appendChild(el);
  });
  highlightCategory(activeCategory);
}

function highlightCategory(cat){
  document.querySelectorAll('.category-item').forEach(e=>{ e.style.background='transparent'; e.style.color='#d6eefc'; });
  const items = Array.from(document.querySelectorAll('.category-item')).filter(x=>x.innerText===cat);
  if(items[0]){ items[0].style.background='#063048'; items[0].style.color='#fff'; }
}

async function add(){
  const isbn=document.getElementById('isbn').value;
  const title=document.getElementById('title').value;
  const author=document.getElementById('author').value;
  const category=document.getElementById('category').value;
  const res = await fetch('/clerk/books',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({isbn,title,author,category})});
  const json = await res.json();
  document.getElementById('addResult').innerText = JSON.stringify(json);
  fetchBooks();
}

async function archive(id){
  if(!confirm('Delete this book?')) return;
  const res = await fetch('/clerk/books/'+id,{method:'DELETE'});
  const j = await res.json();
  alert(JSON.stringify(j));
  fetchBooks();
}

function edit(id){
  const title = prompt('New title');
  if(title===null) return;
  fetch('/clerk/books/'+id,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({title})}).then(r=>r.json()).then(j=>{alert(JSON.stringify(j));fetchBooks()})
}

window.addEventListener('load', ()=>{document.getElementById('addBtn').addEventListener('click', add); fetchBooks()})
</script>
</body>
</html>
